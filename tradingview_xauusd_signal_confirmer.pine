
//@version=5
indicator("XAUUSD Signal Confirmer (Reversal + Breakout)", overlay=true)

// Settings
lengthBB   = input.int(20, "BB Length")
mult       = input.float(2.0, "BB Std Dev")
lengthRSI  = input.int(14, "RSI Length")
lengthK    = input.int(14, "Stoch K Length")
lengthD    = input.int(3, "Stoch D Smoothing")

basis, upper, lower = ta.bb(close, lengthBB, mult)
rsi_val             = ta.rsi(close, lengthRSI)
k = ta.stoch(close, high, low, lengthK)
d = ta.sma(k, lengthD)

// Reversal conditions
longReversal  = close <= lower and rsi_val < 30 and ta.crossover(k, d) and close > open
shortReversal = close >= upper and rsi_val > 70 and ta.crossunder(k, d) and close < open

// Breakout conditions (simple squeeze + break)
width        = (upper - lower) / basis
avg_width    = ta.sma(width, 20)
squeeze      = width < avg_width

longBreakout  = squeeze and close > upper
shortBreakout = squeeze and close < lower

// Plot BB for visual
plot(basis, "BB Basis", color=color.orange)
plot(upper, "BB Upper", color=color.new(color.blue, 0))
plot(lower, "BB Lower", color=color.new(color.blue, 0))

// Visual background
bgcolor(longReversal  ? color.new(color.green, 85) : na)
bgcolor(shortReversal ? color.new(color.red, 85)   : na)
bgcolor(longBreakout  ? color.new(color.green, 90) : na)
bgcolor(shortBreakout ? color.new(color.red, 90)   : na)

symbol = syminfo.ticker

// JSON messages
longRevMsg   = '{"symbol":"' + symbol + '","direction":"BUY","mode":"Reversal"}'
shortRevMsg  = '{"symbol":"' + symbol + '","direction":"SELL","mode":"Reversal"}'
longBrkMsg   = '{"symbol":"' + symbol + '","direction":"BUY","mode":"Breakout"}'
shortBrkMsg  = '{"symbol":"' + symbol + '","direction":"SELL","mode":"Breakout"}'

if longReversal and barstate.isconfirmed
    alert(longRevMsg, alert.freq_once_per_bar_close)

if shortReversal and barstate.isconfirmed
    alert(shortRevMsg, alert.freq_once_per_bar_close)

if longBreakout and barstate.isconfirmed
    alert(longBrkMsg, alert.freq_once_per_bar_close)

if shortBreakout and barstate.isconfirmed
    alert(shortBrkMsg, alert.freq_once_per_bar_close)
